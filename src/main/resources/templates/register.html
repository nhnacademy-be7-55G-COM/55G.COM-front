<!DOCTYPE html>
<html lang="ko">
<head>
  <title>회원가입</title>
  <meta charset="utf-8">
  <th:block th:replace="~{fragments/head :: headTemplate}"></th:block>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* 전체 폼 디자인 */
    .form-label {
      color: var(--dark-color);
      font-weight: 600;
    }

    .form-control {
      border-radius: 0.25rem;
      box-shadow: none;
    }

    /* 아이디 중복확인 버튼 */
    #checkIdBtn {
      background-color: var(--accent-color);
      border: none;
      color: #fff;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 0.25rem;
    }

    #checkIdBtn:hover {
      background-color: var(--dark-color);
    }

    /* 에러 메시지 */
    .error-message {
      color: red;
      font-size: 0.9rem;
      display: none;
    }

    /* 비밀번호 확인 에러 */
    #passwordError {
      color: red;
      font-size: 0.9rem;
      display: none;
    }

    /* 회원가입 버튼 활성화 시 디자인 */
    #submitBtn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    /* 폼 버튼 디자인 */
    .btn-primary {
      background-color: var(--accent-color);
      color: white;
      border-radius: 0.25rem;
      padding: 10px;
    }

    .btn-primary:hover {
      background-color: var(--dark-color);
    }

    /* 전화번호 필드 */
    .phone-input {
      width: 100%;
      padding-left: 12px;
    }

    /* 아이디 입력칸 디자인 */
    #loginId {
      height: 38px;
      font-size: 0.9rem;
    }

    .input-group {
      display: flex;
      align-items: center;
    }

    /* 아이디 입력란과 버튼 간격 조정 */
    .input-group input {
      border-radius: 0.25rem 0 0 0.25rem;
      height: 38px;
    }

    .input-group button {
      height: 38px;
      border-radius: 0 0.25rem 0.25rem 0;
      padding: 8px 16px;
    }

    /* 회원가입 전체 폼 디자인 */
    main {
      background-color: var(--light-color);  /* 페이지의 배경색에 맞춘 색상 */
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* 카드 그림자 */
    }

    /* 회원가입 카드 배경색 */
    .container {
      background-color: var(--light-color); /* 페이지 배경색과 비슷한 색상 */
    }
  </style>
</head>

<body style="background-color: var(--light-color); font-family: var(--body-font),serif; color: var(--body-text-color);">
<div th:replace="~{fragments/header}"></div>

<main class="container my-5 mx-auto" style="max-width: 500px;">
  <h2 class="text-center mb-4" style="color: var(--dark-color); font-family: var(--heading-font),serif;">회원가입</h2>

  <!-- Error Alert Section -->
  <div th:if="${error}" class="alert alert-danger" role="alert" th:text="${error}"></div>

  <form action="/register" method="post">
    <div class="form-group">
      <label for="loginId" class="form-label">아이디</label>
      <div class="input-group">
        <input type="text" class="form-control" id="loginId" style="margin-right: 20px" name="loginId" placeholder="아이디 (최소 4글자)" required>
        <button type="button" class="btn btn-outline-secondary" style="margin-top: -6px" id="checkIdBtn" onclick="checkId()">중복확인</button>
      </div>
      <div id="idError" class="error-message">아이디가 이미 존재합니다.</div>
    </div>

    <div class="form-group">
      <label for="password" class="form-label">비밀번호</label>
      <input type="password" class="form-control" id="password" name="password" placeholder="비밀번호 (최소 4글자)" required oninput="checkPasswordMatch()">
    </div>

    <div class="form-group">
      <label for="confirmPassword" class="form-label">비밀번호 확인</label>
      <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required oninput="checkPasswordMatch()">
      <div id="passwordError" class="error-message">비밀번호가 일치하지 않습니다.</div>
    </div>

    <div class="form-group">
      <label for="name" class="form-label">이름</label>
      <input type="text" class="form-control" id="name" name="name" required>
    </div>

    <div class="form-group">
      <label for="email" class="form-label">이메일</label>
      <input type="email" class="form-control" id="email" name="email" required>
    </div>

    <div class="form-group">
      <label for="phoneNumber" class="form-label">핸드폰 번호</label>
      <input type="tel" class="form-control phone-input" id="phoneNumber" name="phoneNumber" placeholder="010-0000-0000" required oninput="formatPhoneNumber()">
      <div id="phoneError" class="error-message">핸드폰 번호는 '010-0000-0000' 형식으로 입력해야 합니다.</div>
    </div>

    <div class="form-group">
      <label for="birthDate" class="form-label">생일</label>
      <input type="date" class="form-control" id="birthDate" name="birthDate" required min="1900-01-01" max="2024-12-31">
    </div>

    <button type="submit" id="submitBtn" class="btn btn-primary w-100" style="--bs-btn-bg: var(--accent-color); --bs-btn-hover-bg: var(--dark-color);" disabled>회원가입</button>
  </form>
</main>

<div th:replace="~{fragments/footer}"></div>

<script>
  let isIdValid = false;

  // 아이디 중복 확인 함수
  function checkId() {
    const loginId = document.getElementById("loginId").value;
    // 아이디 양식 검증 (영문자, 숫자 포함, 최소 4글자)
    const idPattern = /^[a-zA-Z0-9]{4,}$/; // 최소 4글자 이상, 알파벳, 숫자만 허용

    if (!idPattern.test(loginId)) {
      alert("아이디는 최소 4글자 이상의 영문자와 숫자만 사용할 수 있습니다.");
      return;  // 양식이 맞지 않으면 중복 확인을 하지 않음
    }

    fetch(`/mypage/checkId/${loginId}`, {
      method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
      // 중복 여부에 따라 처리
      if (data) {
        alert("아이디가 중복되었습니다.");
        isIdValid = false; // 중복이므로 유효하지 않음
      } else {
        alert("사용 가능한 아이디입니다.");
        isIdValid = true; // 유효한 아이디
      }
      toggleSubmitButton(); // 회원가입 버튼 상태 변경
    })
    .catch(error => console.error('Error:', error));
  }

  // 회원가입 버튼 상태 변경 함수
  function toggleSubmitButton() {
    const submitBtn = document.getElementById("submitBtn");
    submitBtn.disabled = !isIdValid;
  }

  function checkPasswordMatch() {
    const password = document.getElementById("password").value;
    const confirmPassword = document.getElementById("confirmPassword").value;
    const passwordError = document.getElementById("passwordError");
    const submitBtn = document.getElementById("submitBtn");

    if (password !== confirmPassword || password === "" || confirmPassword === "" || !isIdValid) {
      passwordError.style.display = "block";
      submitBtn.disabled = true;
    } else {
      passwordError.style.display = "none";
      submitBtn.disabled = false;
    }
  }

  function formatPhoneNumber() {
    const phoneInput = document.getElementById("phoneNumber");
    const phoneError = document.getElementById("phoneError");

    let phoneValue = phoneInput.value.replace(/[^0-9]/g, '');

    if (phoneValue.startsWith("010")) {
      if (phoneValue.length <= 3) {
        phoneInput.value = phoneValue;
      } else if (phoneValue.length <= 7) {
        phoneInput.value = `${phoneValue.slice(0, 3)}-${phoneValue.slice(3)}`;
      } else if (phoneValue.length <= 11) {
        phoneInput.value = `${phoneValue.slice(0, 3)}-${phoneValue.slice(3, 7)}-${phoneValue.slice(7, 11)}`;
      }
    } else {
      phoneError.style.display = "block";
      return;
    }

    phoneError.style.display = (phoneValue.length === 11) ? "none" : "block";
  }

  const today = new Date().toISOString().split("T")[0];
  document.getElementById("birthDate").setAttribute("max", today);
</script>


<script src="/static/js/jquery-1.11.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
        crossorigin="anonymous"></script>
<script src="/static/js/plugins.js"></script>
<script src="/static/js/script.js"></script>

</body>
</html>
